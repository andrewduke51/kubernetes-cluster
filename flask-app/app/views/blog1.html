<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'><strong>The Problem:</strong></p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>&nbsp;</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>In one of my projects, I had to containerize a monolithic Application into micro services. Obviously, I faced many challenges. But in this blog post, I will discuss the challenge I faced with an ensemble of 3 zookeepers on Virtual Machines that needed to run on containers.</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>&nbsp;</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>Like everyone else, I started by going over the Kubernetes documentation, and fortunately, I found an example that is specifically written for zookeepers. &nbsp;At first, I thought, &ldquo;Wow, finally! Most of the work is already done.&rdquo; <span style='font-family:"Segoe UI Emoji",sans-serif;'>ðŸ˜‰</span></p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>&nbsp;</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>However, I found that the provided solution from the Kubernetes example and documentation to populate zookeepers <span style="color:#2F5496;">myid</span> file was causing issues each time I deployed an update to the zookeeper ensemble on Kubernetes.</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>&nbsp;</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>Notably, the StatefulSet pvc (persistent volume claim) may have had a previous id of 1 and will now use id 2 after deployment since the pvc will mount to a random new pod that gets scheduled to start, which in turn leads to the SOLR cluster to lose data and also entire collections!</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>&nbsp;</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>Here is the example two-part snippet from <a href="https://kubernetes.io/docs/tutorials/stateful-application/zookeeper/">zookeeper on kubernetes.io</a>.</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>&nbsp;</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;background:#2B2B2B;'><span style='font-size:13px;font-family:"Courier New";color:#CC7832;'>for&nbsp;</span><span style='font-size:13px;font-family:"Courier New";color:#A9B7C6;'>i&nbsp;</span><span style='font-size:13px;font-family:"Courier New";color:#CC7832;'>in&nbsp;</span><span style='font-size:13px;font-family:"Courier New";color:#6897BB;'>0 1 2</span><span style='font-size:13px;font-family:"Courier New";color:#A9B7C6;'>;<br>&nbsp; &nbsp;</span><span style='font-size:13px;font-family:"Courier New";color:#CC7832;'>do&nbsp;</span><span style='font-size:13px;font-family:"Courier New";color:#C57633;'>echo&nbsp;</span><span style='font-size:13px;font-family:"Courier New";color:#6A8759;'>&quot;myid zk-</span><span style='font-size:13px;font-family:"Courier New";color:#A9B7C6;'>$i</span><span style='font-size:13px;font-family:"Courier New";color:#6A8759;'>&quot;</span><span style='font-size:13px;font-family:"Courier New";color:#A9B7C6;'>;<br>&nbsp; &nbsp; &nbsp;&nbsp;</span><span style='font-size:13px;font-family:"Courier New";color:#C57633;'>kubectl&nbsp;</span><span style='font-size:13px;font-family:"Courier New";color:#A9B7C6;'>exec zk-$i -- cat /var/lib/zookeeper/data/myid;<br>&nbsp; &nbsp;</span><span style='font-size:13px;font-family:"Courier New";color:#CC7832;'>done</span></p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>&nbsp;</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>&nbsp;</p>
<p style='margin:0in;font-size:16px;font-family:"Times New Roman",serif;'>As you can see, the snippet above also depends on having the binary for kubectl installed, which I wanted to avoid as I try to follow the principle of &ldquo;less is more&rdquo;. The above process will also delay getting the pods into a healthy state because zookeeper has to negotiate consensus during its leader election phase, and it is rather hard to read.</p>